###
# Test File - Subscriptions Module
# Archivo de prueba para el m√≥dulo de suscripciones
#
# IMPORTANTE: Ejecutar en orden para que las pruebas funcionen correctamente
###

@baseUrl = http://localhost:3000
@adminToken = YOUR_ADMIN_JWT_TOKEN_HERE
@patientToken = YOUR_PATIENT_JWT_TOKEN_HERE

###
# 1. SEED DE PLANES (Solo ejecutar una vez) üå±
# Crea los 3 planes b√°sicos: Basic, Professional, Premium
###
POST {{baseUrl}}/plans/seed
Authorization: Bearer {{adminToken}}
Content-Type: application/json

# Respuesta esperada:
# {
#   "message": "3 planes creados/verificados exitosamente",
#   "plans": [...]
# }

###
# 2. LISTAR TODOS LOS PLANES üìã
# Endpoint p√∫blico (solo requiere autenticaci√≥n)
###
GET {{baseUrl}}/plans
Authorization: Bearer {{patientToken}}

# Respuesta esperada:
# [
#   {
#     "Id": "1",
#     "Name": "Basic",
#     "PriceCents": 0,
#     "Currency": "USD",
#     "FormattedPrice": "Gratis",
#     "FeaturesJson": ["5 consultas m√©dicas por mes", ...],
#     "MaxAppointments": 5
#   },
#   {
#     "Name": "Professional",
#     "PriceCents": 2999,
#     "FormattedPrice": "$29.99 USD/mes",
#     ...
#   },
#   {
#     "Name": "Premium",
#     "PriceCents": 9999,
#     "FormattedPrice": "$99.99 USD/mes",
#     "MaxAppointments": null
#   }
# ]

###
# 3. VER MI SUSCRIPCI√ìN ACTIVA üë§
# Si no tienes suscripci√≥n, se asigna autom√°ticamente el plan Basic
###
GET {{baseUrl}}/subscriptions/me
Authorization: Bearer {{patientToken}}

# Respuesta esperada (primera vez):
# {
#   "Id": "1",
#   "UserId": "5",
#   "PlanId": "1",
#   "StartAt": "2025-10-20T10:00:00Z",
#   "ExpiresAt": null,  // Plan gratuito no expira
#   "IsActive": true,
#   "AutoRenew": false,
#   "Plan": {
#     "Name": "Basic",
#     "PriceCents": 0,
#     "MaxAppointments": 5
#   }
# }

###
# 4. SIMULAR CHECKOUT - PLAN PROFESSIONAL üí≥
# IMPORTANTE: Este endpoint NO cobra dinero real, es una simulaci√≥n
###
POST {{baseUrl}}/subscriptions/checkout
Authorization: Bearer {{patientToken}}
Content-Type: application/json

{
  "PlanId": 2,
  "DurationMonths": 1
}

# Respuesta esperada:
# {
#   "Id": "2",
#   "UserId": "5",
#   "PlanId": "2",
#   "StartAt": "2025-10-20T10:00:00Z",
#   "ExpiresAt": "2025-11-20T10:00:00Z",
#   "IsActive": true,
#   "AutoRenew": true,
#   "Plan": {
#     "Name": "Professional",
#     "PriceCents": 2999,
#     "MaxAppointments": 20
#   }
# }

###
# 5. SIMULAR CHECKOUT - PLAN PREMIUM (3 meses) üíé
###
POST {{baseUrl}}/subscriptions/checkout
Authorization: Bearer {{patientToken}}
Content-Type: application/json

{
  "PlanId": 3,
  "DurationMonths": 3
}

# Error esperado (ya tienes suscripci√≥n activa):
# {
#   "statusCode": 409,
#   "message": "Ya tienes una suscripci√≥n activa. Canc√©lala primero para cambiar de plan."
# }

###
# 6. VERIFICAR L√çMITE DE CITAS üìä
# Muestra cu√°ntas citas te quedan este mes
###
GET {{baseUrl}}/subscriptions/appointment-limit
Authorization: Bearer {{patientToken}}

# Respuesta esperada (plan Professional):
# {
#   "hasLimit": true,
#   "remaining": 20
# }

# Respuesta esperada (plan Premium):
# {
#   "hasLimit": false,
#   "remaining": null
# }

###
# 7. VER HISTORIAL DE SUSCRIPCIONES üìú
# Muestra todas las suscripciones (activas e inactivas)
###
GET {{baseUrl}}/subscriptions/history
Authorization: Bearer {{patientToken}}

# Respuesta esperada:
# [
#   {
#     "Id": "2",
#     "PlanId": "2",
#     "IsActive": true,
#     "Plan": { "Name": "Professional" }
#   },
#   {
#     "Id": "1",
#     "PlanId": "1",
#     "IsActive": false,
#     "Plan": { "Name": "Basic" }
#   }
# ]

###
# 8. CANCELAR SUSCRIPCI√ìN ‚ùå
# Desactiva la auto-renovaci√≥n (no desactiva la suscripci√≥n inmediatamente)
###
DELETE {{baseUrl}}/subscriptions/cancel
Authorization: Bearer {{patientToken}}

# Respuesta esperada:
# {
#   "Id": "2",
#   "AutoRenew": false,
#   "ExpiresAt": "2025-11-20T10:00:00Z",
#   "message": "Suscripci√≥n cancelada. Seguir√°s teniendo acceso hasta el 2025-11-20."
# }

###
# 9. INTENTAR CANCELAR PLAN BASIC ‚ö†Ô∏è
# Error: No se puede cancelar el plan gratuito
###
DELETE {{baseUrl}}/subscriptions/cancel
Authorization: Bearer {{patientToken}}

# Error esperado:
# {
#   "statusCode": 400,
#   "message": "No puedes cancelar el plan gratuito"
# }

###
# 10. VALIDACIONES - PLAN INEXISTENTE ‚ùå
###
POST {{baseUrl}}/subscriptions/checkout
Authorization: Bearer {{patientToken}}
Content-Type: application/json

{
  "PlanId": 999,
  "DurationMonths": 1
}

# Error esperado:
# {
#   "statusCode": 404,
#   "message": "Plan no encontrado"
# }

###
# 11. VALIDACIONES - DURACI√ìN INV√ÅLIDA ‚ùå
###
POST {{baseUrl}}/subscriptions/checkout
Authorization: Bearer {{patientToken}}
Content-Type: application/json

{
  "PlanId": 2,
  "DurationMonths": 15
}

# Error esperado:
# {
#   "statusCode": 400,
#   "message": ["DurationMonths must not be greater than 12"]
# }

###
# 12. PERMISOS - SOLO PACIENTES PUEDEN SUSCRIBIRSE ‚õî
# Ejecutar con token de DOCTOR o ADMIN
###
POST {{baseUrl}}/subscriptions/checkout
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "PlanId": 2,
  "DurationMonths": 1
}

# Error esperado:
# {
#   "statusCode": 403,
#   "message": "Forbidden resource"
# }
